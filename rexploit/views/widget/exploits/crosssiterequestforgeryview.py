try:
    from rexploit.interfaces.widget import Widget
    from rexploit.lib.io.network import Network
    from rexploit.views.aux.messagebox import MessageBox
    from rexploit.lib.misc.parse import Parse
except ImportError as e:
    from rexploit.interfaces.widget import Widget
    from rexploit.lib.io.network import Network
    from rexploit.views.aux.messagebox import MessageBox
    from rexploit.lib.misc.parse import Parse
    print e
    exit(-1)


class CrossSiteRequestForgeryView(Widget):

    def __init__(self, parent):
        super(CrossSiteRequestForgeryView, self).__init__('csrf', parent)
        self.category = "csrf"

        # Connect buttons
        self.pushButtonExploit.clicked.connect(self.pushButtonExploitClicked)
        self.pushButtonCheck.clicked.connect(self.pushButtonCheckClicked)

    def check(self):
        if Network.ping(self.exploit.ip):
            if str(self.lineEditData.text()):
                return True
            else:
                MessageBox.critical("Error", "You have to complete the data box")
                return False
        else:
            MessageBox.critical("Error", "Destination Host Unreachable")
            return False

    def pushButtonCheckClicked(self):
        if self.check():
            if self.exploit.check():
                self.vulnerable = True
            else:
                self.plainTextEditData.appendPlainText("")
                self.plainTextEditData.appendPlainText("Error. The target is not vulnerable")

    def pushButtonExploitClicked(self):
        if self.check():
            self.plainTextEditData.clear()
            try:
                data = Parse.sanatizeJSONOutput(str(self.lineEditData.text()))
                result = self.exploit.run(data)
                self.plainTextEditData.appendPlainText(result)
                if self.exploit.vulnerable:
                    self.vulnerable = True
            except Exception as e:
                MessageBox.critical("Error", str(e))

    def setExploit(self, exploit):
        self.exploit = exploit
        default = self.exploit.default()
        if default:
            default = Parse.sanatizeJSONInput(default)
            self.lineEditData.setText(default)
