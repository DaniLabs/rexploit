import nmap
from PyQt5.QtCore import QThread

from lib.scan.target import Target


class ScanThread(QThread):
    def __init__(self, communicate):
        QThread.__init__(self)
        self.__host = None
        self.__arguments = None
        self.targets = []
        self.communicate = communicate

    def setArguments(self, arguments):
        self.__arguments = arguments

    def run(self):
        self.targets = []
        nm = nmap.PortScanner()
        host = self.__host
        arguments = self.__arguments
        nm.scan(host, arguments=arguments)

        for host in nm.all_hosts():
            for proto in nm[host].all_protocols():
                ports = list(nm[host][proto].keys())
                ports.sort()
                for port in ports:
                    target = Target()
                    target.port = port
                    target.protocol = proto
                    target.name = nm[host][proto][port]['name']
                    target.state = nm[host][proto][port]['state']
                    target.product = nm[host][proto][port]['product']
                    target.info = nm[host][proto][port]['extrainfo']
                    target.version = nm[host][proto][port]['version']

                    self.targets.append(target)

        self.communicate.finish.emit(self.targets)

    def setHost(self, host):
        self.__host = host
