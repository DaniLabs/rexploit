from PyQt5.QtCore import QThread
from lib.scan.target import Target


class ScanThread(QThread):
    def __init__(self, communicate):
        QThread.__init__(self)
        self.__host = None
        self.__arguments = None
        self.__targets = []
        self.__communicate = communicate

    @property
    def arguments(self):
        return self.__arguments

    @arguments.setter
    def arguments(self, arguments):
        self.__arguments = arguments

    @property
    def host(self):
        return self.host

    @host.setter
    def host(self, host):
        self.__host = host

    def run(self):
        try:
            from nmap import __version__
        except ImportError:
            self.__communicate.finishScan.emit([])
            return

        from nmap import PortScanner
        self.__targets = []
        nm = PortScanner()
        host = self.__host
        arguments = self.__arguments
        nm.scan(host, arguments=arguments)

        for host in nm.all_hosts():
            for proto in nm[host].all_protocols():
                ports = list(nm[host][proto].keys())
                ports.sort()
                for port in ports:
                    target = Target(protocol=proto,
                                    port=port,
                                    name=nm[host][proto][port]['name'],
                                    state=nm[host][proto][port]['state'],
                                    product=nm[host][proto][port]['product'],
                                    info=nm[host][proto][port]['extrainfo'],
                                    version=nm[host][proto][port]['version'])

                    self.__targets.append(target)

        self.__communicate.finishScan.emit(self.__targets)
