import nmap
from PyQt4.QtCore import QThread
from PyQt4.QtCore import SIGNAL

from target_model import Target


class ScanThread(QThread):
    def __init__(self):
        QThread.__init__(self)
        self.signal = SIGNAL("signal")
        self.host = None
        self.ports = None

    def run(self):
        targets = []
        nm = nmap.PortScanner()
        host = self.host
        ports = self.ports
        nm.scan(host, ports, arguments="-sV -T4")
        print nm.scanstats()
        print nm.scaninfo()
        print nm._scan_result

        for host in nm.all_hosts():
            for proto in nm[host].all_protocols():
                ports = list(nm[host][proto].keys())
                ports.sort()
                for port in ports:
                    target = Target()
                    target.port = port
                    target.protocol = proto
                    target.name = nm[host][proto][port]['name']
                    target.state = nm[host][proto][port]['state']
                    target.product = nm[host][proto][port]['product']
                    target.extra_info = nm[host][proto][port]['extrainfo']
                    target.version = nm[host][proto][port]['version']

                    targets.append(target)
        self.emit(self.signal, targets)
