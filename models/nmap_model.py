import nmap


class NmapModel:
    def __init__(self):
        self.nm = nmap.PortScanner()
        self.host = None
        self.ports = None
        self.targets = []

    def set_host(self, host):
        self.host = host

    def set_ports(self, ports):
        self.ports = ports

    def start(self):
        self.targets = []
        self.nm.scan(self.host, self.ports)
        for host in self.nm.all_hosts():
            for proto in self.nm[host].all_protocols():
                ports = list(self.nm[host][proto].keys())
                ports.sort()
                for port in ports:
                    target = NmapPort()
                    target.port = port
                    target.protocol = proto
                    if 'name' in self.nm[host][proto][port]:
                        target.name = self.nm[host][proto][port]['name']
                    if 'state' in self.nm[host][proto][port]:
                        target.state = self.nm[host][proto][port]['state']
                    if 'product' in self.nm[host][proto][port]:
                        target.product = self.nm[host][proto][port]['product']
                    if 'extrainfo' in self.nm[self.host][proto][port]:
                        target.extra_info = self.nm[host][proto][port]['extrainfo']
                    if 'version' in self.nm[host][proto][port]:
                        target.version = self.nm[host][proto][port]['version']

                        self.targets.append(target)

    def get_scaninfo(self):
        return self.nm.scaninfo()

    def get_targets(self):
        return self.targets

    @staticmethod
    def parse_file(sections):
        targets = []
        for section in sections:
            target = NmapPort()
            target.protocol = section[0][1]
            target.port = section[1][1]
            target.name = section[2][1]
            target.state = section[3][1]
            target.product = section[4][1]
            target.extra_info = section[5][1]
            targets.append(target)
        return targets


class NmapPort:
    def __init__(self):
        self.protocol = None
        self.port = None
        self.name = None
        self.state = None
        self.product = None
        self.extra_info = None
        self.version = None
