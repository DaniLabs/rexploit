import re
import sqlite3
from subprocess import Popen, PIPE


class OUIModel:
    def __init__(self):
        self.c = None
        self.__connect()

    def __connect(self):
        connexion = sqlite3.connect('./models/db/oui.db')
        self.c = connexion.cursor()

    @staticmethod
    def __get_mac_oui(ip):
        pid = Popen(["arp", "-n", ip], stdout=PIPE)
        result = re.search(r"(([a-f\d]{1,2}\:){5}[a-f\d]{1,2})", pid.communicate()[0])

        if result:
            mac = result.groups()[0]
            oui = "".join(map(lambda i: mac.split(":")[i].upper(), range(3)))
            return mac, oui
        else:
            return None, None


    def __fetchone(self, oui):
        data = (oui,)
        self.c.execute('SELECT * FROM oui WHERE oui LIKE ?', data)
        return self.c.fetchone()

    def get_information(self, ip):
        mac, oui = self.__get_mac_oui(ip)
        return mac, self.__fetchone(oui)
