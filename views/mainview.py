# Imports
from PyQt5.uic import loadUi
from PyQt5.QtWidgets import QMainWindow
from PyQt5.QtGui import QCloseEvent
from views.misc.messagebox import MessageBox


class MainView(QMainWindow):

    """
        This class is a view inherit from QMainWindow. This class is the main view.
    """

    def __init__(self, mainController):

        """Initialize the view object and all attributes that it needs"""
        super(MainView, self).__init__()
        self.__mainController = mainController

    def actionAboutClicked(self):
        """This function is executed when actionAbout is clicked."""
        self.__mainController.actionAbout()

    def actionNewProjectClicked(self):
        """This function is executed when actionNewProject is clicked."""
        self.__mainController.actionNewProject()

    def actionOpenProjectClicked(self):
        """This function is executed when actionOpenProject is clicked."""
        self.__mainController.actionOpenProject()

    def actionRefreshExploitsClicked(self):
        """This function is executed when actionRefreshExploits is clicked."""
        self.__mainController.actionRefreshExploits()

    def actionReportPDFClicked(self):
        """This function is executed when actionReportPDF is clicked."""
        self.__mainController.actionReportPDF()

    def actionSaveClicked(self):
        """This function is executed when actionSave is clicked."""
        self.__mainController.actionSave()

    def actionSettingsClicked(self):
        """This function is executed when actionSave is clicked."""
        self.__mainController.actionSettings()

    def actionUpdateClicked(self):
        """This function is executed when actionSave is clicked."""
        self.__mainController.actionUpdate()

    def buildUI(self, widgets):
        """
        Build the main view and connect all functions
        :param widgets: a dict with all tabs
        :return: None
        """
        # key is name, value is the object
        for key, value in widgets.iteritems():
            self.tabWidget.addTab(value, key)

        # Connect buttons toolbar
        self.actionTAbout.triggered.connect(self.actionAboutClicked)
        self.actionTNew.triggered.connect(self.actionNewProjectClicked)
        self.actionTOpen.triggered.connect(self.actionOpenProjectClicked)
        self.actionTRefreshExploits.triggered.connect(self.actionRefreshExploitsClicked)
        self.actionTExportPDF.triggered.connect(self.actionReportPDFClicked)
        self.actionTSave.triggered.connect(self.actionSaveClicked)
        self.actionTSettings.triggered.connect(self.actionSettingsClicked)
        self.actionTUpdate.triggered.connect(self.actionUpdateClicked)

        # Connect buttons menubar
        self.actionMAbout.triggered.connect(self.actionAboutClicked)
        self.actionMNew.triggered.connect(self.actionNewProjectClicked)
        self.actionMOpen.triggered.connect(self.actionOpenProjectClicked)
        self.actionMRefreshExploits.triggered.connect(self.actionRefreshExploitsClicked)
        self.actionMExportPDF.triggered.connect(self.actionReportPDFClicked)
        self.actionMSave.triggered.connect(self.actionSaveClicked)
        self.actionMSettings.triggered.connect(self.actionSettingsClicked)
        self.actionMUpdate.triggered.connect(self.actionUpdateClicked)
        self.actionMQuit.triggered.connect(self.actionQuitClicked)

    def actionQuitClicked(self):
        self.close()

    def closeEvent(self, event):
        """This function is executed when main window will close."""
        if MessageBox.question("Confirm Exit", "Are you sure you want to exit ?"):
            event.accept()
        else:
            event.ignore()

    def startUi(self):
        """This function checks if ui file exists and then show the view"""
        try:
            loadUi('./resources/ui/mainwindow.ui', self)

            # Disable buttons
            self.setEnabledItems(False)
            self.show()
        except Exception as e:
            MessageBox.critical("Error", str(e))

    def setEnabledItems(self, b):
        """
        Enabled or disabled some gui's elements
        :param b: False or True
        :return: None
        """
        self.actionTSave.setEnabled(b)
        self.actionTSettings.setEnabled(b)
        self.actionTRefreshExploits.setEnabled(b)
        self.actionTExportPDF.setEnabled(b)

    def setMessageStatus(self, message):
        """
        Set a message status on statusbar
        :param message: the text
        :return: None
        """
        self.statusbar.showMessage(message)

    def setTabIndex(self, i=0):
        """
        Set the tab with index n
        :param i: index of tab
        :return: None
        """
        if self.tabWidget.currentIndex() != i:
            self.tabWidget.setCurrentIndex(i)

    def setTitle(self, text):
        """
        Set a window title
        :param text: the text
        :return: None
        """
        self.setWindowTitle("{0} - {1}".format(self.windowTitle().split("-")[0][:-1], text))
