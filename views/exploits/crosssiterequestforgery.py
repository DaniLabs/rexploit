from PyQt5.uic import loadUi

from PyQt5.QtCore import Qt
from PyQt5.QtWidgets import QWidget

from views.misc.messagebox import MessageBox


class CrossSiteRequestForgeryView(QWidget):
    def __init__(self, parent):
        super(CrossSiteRequestForgeryView, self).__init__(parent)
        loadUi('./views/ui/exploits/crosssiterequestforgery.ui', self)
        self.exploit = None
        self.category = "csrf"

        # Connect buttons
        self.pushButtonExploit.clicked.connect(self.pushButtonExploitClicked)
        self.labelAuthor.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelDate.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelCWE.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelCVE.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelReferences.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelDescription.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelDescription.setWordWrap(True)

        # Set verticalLayout. It's resize the widget
        self.setLayout(self.verticalLayout)

    def check(self):
        if not self.lineEditData.text():
            MessageBox.critical("Error", "You have to complete the data box")
            return False
        else:
            return True

    def getCategory(self):
        return self.category

    def pushButtonExploitClicked(self):
        if self.check():
            data = self.lineEditData.text()
            self.plainTextEditData.clear()
            try:
                data = self.sanitizeOutput(data)
                result = self.exploit.run(data)
                self.plainTextEditData.appendPlainText(result)
            except Exception as e:
                MessageBox.critical("Error", str(e.args))

    @staticmethod
    def sanitizeOutput(data):
        out = {}
        data = data.replace(" ", "")
        c = data.split(",")
        for a in c:
            d = a.split(":")
            out[d[0]] = d[1]

        return out

    def setExploit(self, exploit):
        self.exploit = exploit
        self.labelNameExploit.setText(self.exploit.getName())
        self.labelAuthor.setText(self.exploit.getAuthors())
        self.labelDate.setText(self.exploit.getDate())
        self.labelCWE.setText(self.exploit.getCWE())
        self.labelCVE.setText(self.exploit.getCVE())
        self.labelReferences.setText(self.exploit.getReferences())
        self.labelDescription.setText(self.exploit.getDescription())
        self.plainTextEditData.appendPlainText("")
        default = self.exploit.default()
        if default:
            default = str(default).replace("'", "").replace("{", "").replace("}", "")
            self.lineEditData.setText(default)
