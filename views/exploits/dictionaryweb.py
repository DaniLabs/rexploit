from PyQt5.uic import loadUi
from PyQt5.QtCore import Qt, QRegExp
from PyQt5.QtWidgets import QWidget
from PyQt5.QtGui import QRegExpValidator, QValidator
from views.misc.filedialog import FileDialog
from views.misc.messagebox import MessageBox
from lib.io.network import ping
from lib.thread.communicate import Communicate
from lib.thread.exploitthread import ExploitThread
from lib.io.parse import CWEToLink


class DictionaryWebView(QWidget):
    def __init__(self, parent):
        super(DictionaryWebView, self).__init__(parent)
        loadUi('./resources/ui/exploits/bruteforceweb.ui', self)
        self.__exploit = None
        self.__category = "dicweb"
         
        self.__parent = parent

        regexPort = QRegExp("\d{1,6}")
        self.__validatorPort = QRegExpValidator(regexPort, self.lineEditPort)
        self.lineEditPort.setValidator(self.__validatorPort)

        # Connect buttons
        self.pushButtonExploit.clicked.connect(self.pushButtonExploitClicked)
        self.pushButtonCancel.clicked.connect(self.pushButtonCancelClicked)
        self.checkBoxVulnerable.stateChanged.connect(self.checkBoxVulnerableStateChanged)
        self.labelAuthor.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelDate.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelTarget.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelDescription.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.labelDescription.setWordWrap(True)
        self.toolButtonUsers.clicked.connect(self.toolButtonUsersClicked)
        self.toolButtonPasswords.clicked.connect(self.toolButtonPasswordsClicked)

        self.labelCWE.setTextFormat(Qt.RichText)
        self.labelCWE.setTextInteractionFlags(Qt.TextBrowserInteraction)
        self.labelCWE.setOpenExternalLinks(True)

        self.labelReferences.setTextFormat(Qt.RichText)
        self.labelReferences.setTextInteractionFlags(Qt.TextBrowserInteraction)
        self.labelReferences.setOpenExternalLinks(True)

        # Set verticalLayout. It's resize the widget
        self.setLayout(self.verticalLayout)

        # Connect signal
        self.__communicate = Communicate()
        self.__exploitThread = ExploitThread(self.__communicate)
        self.__communicate.finishExploit.connect(self.setResultExploit)

        # Button and progressbar
        self.setProgressBarState(0)
        self.pushButtonCancel.setEnabled(False)

    def check(self):
        if ping(self.__exploit.ip):
            if not self.isPort() or not self.lineEditUsers.text() or not self.lineEditPasswords.text():
                MessageBox.critical("Error", "You have to complete the information")
                return False
            else:
                return True
        else:
            MessageBox.critical("Error", "Destination Host Unreachable")
            return False

    def checkBoxVulnerableStateChanged(self):
        if self.checkBoxVulnerable.isChecked():
            self.__parent.addExploitSuccess(self.__exploit)
        else:
            self.__parent.removeExploitSuccess(self.__exploit)

    def getCategory(self):
        return self.__category

    def isPort(self):
        if self.lineEditPort.text():
            state = self.__validatorPort.validate(self.lineEditPort.text(), 0)[0]
            return state == QValidator.Acceptable
        else:
            return False

    def pushButtonCheckClicked(self):
        if self.__exploit.check():
            self.__exploit.vulnerable =  True
            self.checkBoxVulnerable.setCheckState(Qt.Checked)
        else:
            self.plainTextEditData.appendPlainText("")
            self.plainTextEditData.appendPlainText("Error. The target is not vulnerable")

    def pushButtonCancelClicked(self):
        self.__exploitThread.terminate()
        self.setProgressBarState(3)
        self.pushButtonCancel.setEnabled(False)
        self.pushButtonExploit.setEnabled(True)

    def pushButtonExploitClicked(self):
        if self.check():
            self.plainTextEditData.clear()
            try:
                self.setProgressBarState(2)
                self.pushButtonExploit.setEnabled(False)
                self.pushButtonCancel.setEnabled(True)

                data = {"port": int(self.lineEditPort.text()),
                       "users": self.lineEditUsers.text(),
                       "passwords": self.lineEditPasswords.text(),
                       "url": self.lineEditURL.text()}

                self.__exploitThread.setExploit(self.__exploit, data)
                self.__exploitThread.start()
            except Exception as e:
                MessageBox.critical("Error", str(e.args))

    def setExploit(self, exploit):
        self.__exploit = exploit

        self.labelNameExploit.setText(self.__exploit.name)
        self.labelAuthor.setText(self.__exploit.authors)
        self.labelDate.setText(self.__exploit.date)

        link = CWEToLink(self.__exploit.cwe)
        self.labelCWE.setText(link)
        self.labelTarget.setText(self.__exploit.target)
        self.labelReferences.setText(self.__exploit.references)
        self.labelDescription.setText(self.__exploit.description)
        self.plainTextEditData.appendPlainText("")

        default = self.__exploit.default()

        if default:
            self.lineEditPort.setText(default["port"])
            self.lineEditUsers.setText(default["users"])
            self.lineEditPasswords.setText(default["passwords"])
            self.lineEditURL.setText(default["url"])

    def setProgressBarState(self, state):
        if state == 0:
            self.progressBar.hide()
            self.progressBar.setRange(0, 1)
            self.progressBar.setValue(0)
        elif state == 1:
            self.progressBar.setFormat("Waiting")
            self.progressBar.setRange(0, 1)
            self.progressBar.setValue(0)
        elif state == 2:
            self.progressBar.setFormat("Exploiting")
            self.progressBar.setRange(0, 0)
            self.progressBar.show()
        elif state == 3:
            self.progressBar.setFormat("Completed")
            self.progressBar.setRange(0, 1)
            self.progressBar.setValue(1)
            self.progressBar.show()

    def setResultExploit(self, result):
        if "Success" in result:
            self.__exploit.vulnerable = True
            self.setCheckBoxVulnerableChecked()

        self.plainTextEditData.appendPlainText(result)
        self.setProgressBarState(3)
        self.pushButtonExploit.setEnabled(True)

    def toolButtonUsersClicked(self):
        self.lineEditUsers.setText(FileDialog.getOpenFileName("txt"))

    def toolButtonPasswordsClicked(self):
        self.lineEditPasswords.setText(FileDialog.getOpenFileName("txt"))
