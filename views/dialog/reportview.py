from os import W_OK, access
from os.path import expanduser, join, exists
from PyQt5.uic import loadUi
from PyQt5.QtWidgets import QDialog
from views.misc.filedialog import FileDialog
from views.misc.messagebox import MessageBox


class ReportView(QDialog):
    def __init__(self, reportContoller):
        super(ReportView, self).__init__()
        self.__reportController = reportContoller
        loadUi('./resources/ui/dialog/report.ui', self)

        self.lineEditLocation.setText(expanduser("~"))

        self.__name = None

        # Connect things
        self.buttonBox.rejected.connect(self.buttonBoxRejected)
        self.buttonBox.accepted.connect(self.buttonBoxAccepted)
        self.toolButton.clicked.connect(self.toolButtonClicked)

    def buttonBoxAccepted(self):
        b, path = self.isLocation()
        if b:
            self.__reportController.save(path, self.textEditComment.toPlainText())
            self.accept()
            self.done(1)
        else:
            self.done(-1)

    def buttonBoxRejected(self):
        self.reject()

    def isLocation(self):
        location = str(self.lineEditLocation.text())
        if not location:
            MessageBox.critical("Error", "You have to add a location")
            return False, None

        path = join(location, self.__name)
        if not exists(path + ".pdf") and access(str(self.lineEditLocation.text()), W_OK):
            return True, path
        else:
            MessageBox.critical("Error", "Exist a report with same name on this path ({}.pdf).".format(path))
            return False, None

    def toolButtonClicked(self):
        self.lineEditLocation.setText(FileDialog.getExistingDirectory())

    def setName(self, name):
        self.__name = name
