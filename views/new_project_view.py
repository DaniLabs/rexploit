import os
from os.path import expanduser

from PyQt4.QtCore import QRegExp
from PyQt4.QtGui import QWidget, QRegExpValidator, QValidator

from gen.ui_new_project import UiNewProject
from misc.messagebox import MessageBox


class NewProjectView(QWidget):

    def __init__(self, project_controller):
        super(NewProjectView, self).__init__()
        self.project_controller = project_controller
        self.ui = None
        self.validator = None
        self.build_ui()

    def build_ui(self):
        self.ui = UiNewProject()
        self.ui.setup_ui()
        self.ui.lineEdit_location.setText(expanduser("~"))
        regex = QRegExp("\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}")
        self.validator = QRegExpValidator(regex, self.ui.lineEdit_ip)
        self.ui.lineEdit_ip.setValidator(self.validator)
        self.ui.button_cancel.clicked.connect(self.__reject)
        self.ui.button_create.clicked.connect(self.__accept)

    def exec_(self):
        return self.ui.exec_()

    def __accept(self):
        value = self.__check_values()
        m = MessageBox()
        if value == 1:
            self.project_controller = self.project_controller.create_project(
                    self.ui.lineEdit_name.text(),
                    self.ui.lineEdit_ip.text(),
                    self.ui.lineEdit_location.text())
            self.ui.done(1)
        elif value == -1:
            m.type_critical("Error", "You must to complete the information")
        elif value == -2:
            m.type_critical("Error", "You have to add an IP")
        elif value == -3:
            m.type_critical("Error", "Exist a project with same name on this path")

    def __check_values(self):
        if self.ui.lineEdit_name.text():
            if self.__check_ip():
                if self.__check_location():
                    return 1
                else:
                    return -3
            else:
                return -2
        else:
            return -1

    def __check_ip(self):
        # Verify if the IP "matches" the regular expression
        #TODO Falta comprobar que podemos hacer ping a esa IP, es decir que el host esta vivo
        state, pos = self.validator.validate(self.ui.lineEdit_ip.text(), 0)
        return state == QValidator.Acceptable

    def __check_location(self):
        location = str(self.ui.lineEdit_location.text())
        name = str(self.ui.lineEdit_name.text())
        path = os.path.join(location, name + ".ini")
        return not os.path.exists(path) and os.access(str(self.ui.lineEdit_location.text()), os.W_OK)

    def __reject(self):
        self.ui.reject()
