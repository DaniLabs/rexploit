from controllers.projectcontroller import ProjectController
from controllers.scancontroller import ScanController
from controllers.settingscontroller import SettingsController
from controllers.vulnerabilitiescontroller import VulnerabilitiesController
from views.mainview import MainView
from views.misc.messagebox import MessageBox


class MainController(object):
    def __init__(self):
        self.mainView = MainView()
        self.projectController = ProjectController()
        self.settingsController = SettingsController()
        self.scanController = ScanController(self.mainView)
        self.vulnerabilitiesController = VulnerabilitiesController(self.mainView)
        self.mainView.buildUI(self.vulnerabilitiesController.getWidget(),
                              self.scanController.getWidget())

        self.mainView.setController(self)

    def actionNewProject(self):
        if self.projectController.showNewProjectView():
            projectFile = self.projectController.getProjectFile()
            self.mainView.setEnabledItems(True)
            self.mainView.setMessageStatus(self.projectController.getMessageStatus())
            self.mainView.setTitle(projectFile.readValue("Information", "Name"))
            self.scanController.setProjectFile(projectFile, True)
            self.vulnerabilitiesController.setProjectFile(projectFile)
            self.settingsController.setProjectFile(projectFile)
        else:
            pass

    def actionOpenProject(self):
        if self.projectController.openProject():
            projectFile = self.projectController.getProjectFile()
            self.mainView.setEnabledItems(True)
            self.scanController.loadProfiles()
            self.mainView.setMessageStatus(self.projectController.getMessageStatus())
            self.mainView.setTitle(projectFile.readValue("Information", "Name"))
            self.scanController.setProjectFile(projectFile, False)
            self.vulnerabilitiesController.setProjectFile(projectFile)
        else:
            pass

    def actionSave(self):
        #TODO actionSave. Guardar los cambios realizados
        if self.scanController.saveTargets():
            if self.vulnerabilitiesController.saveExploits():
                MessageBox.information("Save", "All changes save correctly")
        else:
            MessageBox.critical("Error", "An error happened")
        print "actionSave"

    def actionSettings(self):
        projectFile = self.projectController.getProjectFile()
        self.settingsController.setProjectFile(projectFile)
        self.settingsController.show()
        projectFile = self.settingsController.getProjectFile()
        self.projectController.setProjectFile(projectFile)
        self.mainView.setMessageStatus(self.projectController.getMessageStatus())
        self.mainView.setTitle(projectFile.readValue("Information", "Name"))
        print "actionSettings"

    def actionAbout(self):
        #TODO actionAbout. Mostrar informacion sobre el proyecto, version, autores, licencia, etc...
        print "actionAbout"

    def start(self):
        self.mainView.show()
