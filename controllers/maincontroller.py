from controllers.projectcontroller import ProjectController
from controllers.scancontroller import ScanController
from controllers.vulnerabilitiescontroller import VulnerabilitiesController
from views.dialog.settingsview import SettingsView
from views.mainview import MainView
from views.misc.messagebox import MessageBox


class MainController(object):
    def __init__(self):
        self.mainView = MainView()
        self.projectController = ProjectController()
        self.scanController = ScanController(self.mainView)
        self.vulnerabilitiesController = VulnerabilitiesController(self.mainView)

        self.mainView.buildUI(self.vulnerabilitiesController.getWidget(),
                              self.scanController.getWidget()
                              )

        self.mainView.setController(self)

    def actionNewProject(self):
        if self.projectController.showNewProjectView():
            projectFile = self.projectController.getProjectFile()
            self.mainView.setMessageStatus(self.projectController.getMessageStatus())
            self.scanController.setProjectFile(projectFile, True)
            self.vulnerabilitiesController.setProjectFile(projectFile)
        else:
            pass

    def actionOpenProject(self):
        if self.projectController.openProject():
            projectFile = self.projectController.getProjectFile()
            self.mainView.setEnableddWidgets()
            self.scanController.loadProfiles()
            self.mainView.setMessageStatus(self.projectController.getMessageStatus())
            self.scanController.setProjectFile(projectFile, False)
            self.vulnerabilitiesController.setProjectFile(projectFile)
        else:
            pass

    def actionSave(self):
        #TODO actionSave. Guardar los cambios realizados
        if self.scanController.saveTargets():
            if self.vulnerabilitiesController.saveExploits():
                MessageBox.information("Save", "All changes save correctly")
        else:
            MessageBox.critical("Error", "An error happened")
        print "actionSave"

    def actionSettings(self):
        #TODO actionSettings. Configurar opciones del proyecto. Que opciones.
        self.settingsView = SettingsView(self)
        self.settingsView.exec_()
        print "actionSettings"

    def actionAbout(self):
        #TODO actionAbout. Mostrar informacion sobre el proyecto, version, autores, licencia, etc...
        print "actionAbout"

    def start(self):
        self.mainView.show()
