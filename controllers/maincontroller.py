# Imports
from controllers.aboutcontroller import AboutController
from controllers.projectcontroller import ProjectController
from controllers.reportcontroller import ReportController
from controllers.scancontroller import ScanController
from controllers.settingscontroller import SettingsController
from controllers.updatecontroller import UpdateController
from controllers.vulnerabilitiescontroller import VulnerabilitiesController
from views.mainview import MainView
from views.misc.messagebox import MessageBox


class MainController(object):

    """
        This class is the main controller that manages called 'Main View' an the other controllers.
    """

    def __init__(self):
        """Initialize the controller object and all attributes that they need it"""
        self.__view = MainView(self)

        self.__projectController = ProjectController()
        self.__settingsController = SettingsController()
        self.__reportController = ReportController()
        self.__aboutController = AboutController()
        self.__updateController = UpdateController()
        self.__scanController = ScanController(self.__view)
        self.__vulnerabilitiesController = VulnerabilitiesController(self.__view)

        widgets = {"Exploits": self.__vulnerabilitiesController.getWidget(),
                   "Scan": self.__scanController.getWidget()}

        self.__view.buildUI(widgets)

    def actionAbout(self):
        """This function is executed when actionAbout is clicked."""
        self.__aboutController.show()

    def actionNewProject(self):
        """This function is executed when actionNewProject is clicked."""
        self.__view.setTabIndex(0)
        if self.__projectController.show():
            projectFile = self.__projectController.projectFile
            self.__view.setEnabledItems(True)
            message = "IP: {0} Location: {1} ".format(projectFile.readValue("Information", "IP"),
                                                      projectFile.readValue("Information", "Location"))
            self.__view.setMessageStatus(message)
            title = projectFile.readValue("Information", "Name")
            self.__view.setTitle(title)

            self.__scanController.projectFile = projectFile
            self.__vulnerabilitiesController.projectFile = projectFile
            self.__reportController.projectFile = projectFile
            self.__settingsController.projectFile = projectFile

    def actionOpenProject(self):
        """This function is executed when actionOpenProject is clicked."""
        self.__view.setTabIndex(0)
        if self.__projectController.open():
            projectFile = self.__projectController.projectFile
            self.__view.setEnabledItems(True)
            message = "IP: {0} Location: {1} ".format(projectFile.readValue("Information", "IP"),
                                                      projectFile.readValue("Information", "Location"))
            self.__view.setMessageStatus(message)
            title = projectFile.readValue("Information", "Name")
            self.__view.setTitle(title)

            self.__scanController.projectFile = projectFile
            self.__vulnerabilitiesController.projectFile = projectFile
            self.__reportController.projectFile = projectFile
            self.__settingsController.projectFile = projectFile

    def actionRefreshExploits(self):
        """This function is executed when actionRefreshExploits is clicked."""
        self.__vulnerabilitiesController.refreshExploits()

    def actionReportPDF(self):
        """This function is executed when actionReportPDF is clicked."""
        if self.__reportController.show():
            MessageBox.information("Report PDF", "Your report was saved successfully")

    def actionSave(self):
        """This function is executed when actionSave is clicked."""
        if self.__scanController.save():
            if self.__vulnerabilitiesController.save():
                MessageBox.information("Save", "All changes was saved successfully")

    def actionSettings(self):
        """This function is executed when actionSettings is clicked."""
        if self.__settingsController.show():
            # if and only if button OK is clicked.
            projectFile = self.__settingsController.projectFile
            self.__scanController.projectFile = projectFile
            self.__vulnerabilitiesController.projectFile = projectFile
            self.__reportController.projectFile = projectFile

            message = "IP: {0} Location: {1} ".format(projectFile.readValue("Information", "IP"),
                                                      projectFile.readValue("Information", "Location"))
            self.__view.setMessageStatus(message)
            title = projectFile.readValue("Information", "Name")
            self.__view.setTitle(title)

    def actionUpdate(self):
        """This function is executed when actionUpdate is clicked."""
        self.__updateController.show()

    def start(self):
        """This function is executed when program start"""
        self.__view.show()
