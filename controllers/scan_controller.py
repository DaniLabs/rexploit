from models.scan_model import ScanModel
from views.scan_view import ScanView


class ScanController(object):
    def __init__(self):
        self.model = ScanModel()
        self.scan_view = ScanView(self)
        self.project_file = None
        self.ip = None

    def get_widget(self):
        return self.scan_view.get_ui()

    def get_thread(self):
        return self.model.thread()

    def start_scan(self, ports):
        if self.ip and ports:
            self.scan_view.info()
            self.scan_view.message_status("Scanning...")
            self.model.start(self.ip, ports)
        else:
            self.scan_view.error()

    def set_project_file(self, project_file):
        self.project_file = project_file
        self.ip = str(self.project_file.read_value("Information", "IP"))
        self.__load_targets()

    def get_items(self):
        row,col = self.scan_view.get_row_col()
        for i in xrange(row):
            target = Target()
            target = self.scan_view.get_item(i, 0)

    #TODO Reescribir esta funcion, tenemos que coger los datos de la vista no del modelo
    def save_targets(self):
        pass
        targets = self.get_items()
        if targets:
            for i, target in enumerate(targets):
                section = "Target_%s" % i
                value_read_port = self.project_file.read_value(section, "Port")
                if not value_read_port == target.port:
                        self.project_file.write_on_section(section,
                                                           "Protocol",
                                                           target.protocol)
                        self.project_file.write_on_section(section,
                                                           "Port",
                                                           target.port)
                        self.project_file.write_on_section(section,
                                                           "Name",
                                                           target.name)
                        self.project_file.write_on_section(section,
                                                           "State",
                                                           target.state)
                        self.project_file.write_on_section(section,
                                                           "Product",
                                                           "%s %s" % (target.product, target.version))
                        self.project_file.write_on_section(section,
                                                           "Extra",
                                                           target.extra_info)
                else:
                    pass
        else:
            pass

    def __load_targets(self):
        i = 0
        items = []
        while self.project_file.has_section("Target_%s" % i):
            items.append(self.project_file.read_section("Target_%s" % i))
            i += 1
        targets = self.model.parse_file(items)
        self.scan_view.set_items(targets, True)
