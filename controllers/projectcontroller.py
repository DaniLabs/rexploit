import time

from lib.io.dboui import DBOUI
from lib.io.projectfile import ProjectFile
from views.misc.filedialog import FileDialog
from views.widgets.newprojectview import NewProjectView


class ProjectController(object):
    def __init__(self):
        self.__projectModel = None
        self.__ouiModel = DBOUI()

    def getMessageStatus(self):
        return "IP: {0} Location: {1} ".format(self.__projectModel.readValue("Information", "IP"),
                                               self.__projectModel.readValue("Information", "Location")
                                               )

    def getProjectModel(self):
        return self.__projectModel

    def showNewProjectView(self):
        newProjectView = NewProjectView(self)

        if newProjectView.exec_():
            return True
        else:
            return False

    def createProject(self, name, ip, location):
        mac, oui, company = self.getInformation(ip)

        self.__projectModel = ProjectFile(location, name)
        self.__projectModel.writeOnSection("Information", "Date", "{0} {1}".format(time.strftime("%x"),
                                                                                   time.strftime("%X")))
        self.__projectModel.writeOnSection("Information", "Location", self.__projectModel.getFileName())
        self.__projectModel.writeOnSection("Information", "Name", name)
        self.__projectModel.writeOnSection("Information", "IP", ip)
        self.__projectModel.writeOnSection("Information", "MAC", mac)
        self.__projectModel.writeOnSection("Information", "OUI", oui)
        self.__projectModel.writeOnSection("Information", "Company", company)

    def openProject(self):
        fileName = FileDialog.getOpenFileName()

        if fileName:
            self.__projectModel = ProjectFile(fileName)
            return True
        else:
            return False

    def getInformation(self, ip):
        mac, info = self.__ouiModel.getMACandOUI(ip)

        if not mac and not info:
            mac = oui = company = "Unknown"
        else:
            oui = info[1]
            company = info[2]

        return mac, oui, company
