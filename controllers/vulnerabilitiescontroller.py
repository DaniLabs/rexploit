from importlib import import_module
from os import listdir
from os.path import splitext, isdir, join
from views.misc.messagebox import MessageBox
from views.widgets.vulnerabilitiesview import VulnerabilitiesView
from lib.io.parse import sectionsToExploit
from sys import modules


class VulnerabilitiesController(object):
    def __init__(self, parent):
        self.__vulnerabilitiesView = VulnerabilitiesView(self, parent)
        self.__projectFile = None
        self.__IP = None
        self.__MAC = None
        self.__vulnerabilitiesView.setEnabledItems(False)
        self.findRouters()

    def filesToExploits(self, files, route, refresh=False):
        exploits = []
        try:
            for exploit in files:
                name = 'modules.{0}.{1}'.format(route, exploit)

                if refresh:
                    modules.pop(name)

                # Reload all modules
                if name in modules.keys():
                    # Get a module
                    e = modules.get(name)
                else:
                    # Import a new module
                    e = import_module('.{0}.{1}'.format(route, exploit), 'modules')

                # Create an exploit object and we set IP and MAC
                e = e.Exploit()
                e.setIP(self.__IP)
                e.setMAC(self.__MAC)

                exploits.append(e)
            return exploits
        except ImportError:
            return exploits

    def findExploits(self, router, refresh=False):
        # Generic exploits
        files = filter(lambda x: x,
                       [splitext(f)[0]
                        for f in listdir("./modules/generic/")
                        if f.endswith(".py") and not f.startswith("__")])

        generic = self.filesToExploits(files, 'generic', refresh)

        if router == "None":
            return generic
        else:
            # Specific exploits
            files = filter(lambda x: x,
                           [splitext(f)[0]
                            for f in listdir("./modules/routers/{0}".format(router.lower()))
                            if f.endswith(".py") and not f.startswith("__")])

            specific = self.filesToExploits(files, 'routers.{0}'.format(router.lower()), refresh)

            return generic + specific

    def findRouters(self, refresh=False):
        routers = [f.capitalize() for f in listdir("./modules/routers")
                   if isdir(join("./modules/routers", f)) and
                   not f.startswith("__")]

        self.__vulnerabilitiesView.setRouters(routers, refresh)

    def getWidget(self):
        return self.__vulnerabilitiesView

    def save(self):
        self.__projectFile.write("Information", "Router", self.__vulnerabilitiesView.getRouterActive())

        exploits = self.__vulnerabilitiesView.getExploitSuccess()
        if exploits:
            for i, exploit in enumerate(exploits):
                section = "Exploit_%s" % i
                try:
                    self.__projectFile.write(section, "Name", exploit.getName())
                    self.__projectFile.write(section, "Authors", exploit.getAuthors())
                    self.__projectFile.write(section, "Description", exploit.getDescription())
                    self.__projectFile.write(section, "CWE", exploit.getCWE())
                    self.__projectFile.write(section, "Targets", exploit.getTarget())
                    self.__projectFile.write(section, "References", exploit.getReferences())
                except Exception as e:
                    MessageBox.critical("Error", e.message)
                    return False

            return True

    def setProjectFile(self, projectFile):
        self.__projectFile = projectFile
        self.__IP = str(self.__projectFile.readValue("Information", "IP"))
        self.__MAC = str(self.__projectFile.readValue("Information", "MAC"))
        self.__vulnerabilitiesView.setComboBoxRouter(str(self.__projectFile.readValue("Information", "ROUTER")))
        items = self.__projectFile.getSections("Exploit")
        self.__vulnerabilitiesView.setItemsLoaded(sectionsToExploit(items))

    def start(self, router):
        exploits = self.findExploits(router)
        if exploits:
            self.__vulnerabilitiesView.show()
            self.__vulnerabilitiesView.setExploits(exploits)
        else:
            MessageBox.critical("Error", "We can not found exploits for this router")
