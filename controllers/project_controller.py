import time
from PyQt4 import QtGui
from os.path import expanduser

from models.oui_model import OUIModel
from models.project_model import ProjectModel
from views.new_project_view import NewProjectView


class ProjectController(object):

    def __init__(self):
        self.model = None
        self.model_oui = OUIModel()

    def get_message_status(self):
        return "IP: " + self.model.read_value("Information", "IP") + \
               " Location: " + self.model.read_value("Information", "location")

    def get_project_file(self):
        return self.model.get_file()

    def new_project(self):
        new_project_view = NewProjectView(self)
        if new_project_view.exec_():
            return True
        else:
            return False

    def get_information_ip(self, ip):
        mac, info = self.model_oui.get_information(ip)

        if not mac and not info:
            mac = oui = company = "Unknown"
        else:
            oui = info[1]
            company = info[2]

        return mac, oui, company

    def create_project(self, name, ip, location):
        mac, oui, company = self.get_information_ip(ip)

        self.model = ProjectModel(location, name)
        self.model.write_on_section("Information", "Date", "{0} {1}".format(time.strftime("%x"), time.strftime("%X")))
        self.model.write_on_section("Information", "Location", self.model.filename)
        self.model.write_on_section("Information", "Name", name)
        self.model.write_on_section("Information", "IP", ip)
        self.model.write_on_section("Information", "MAC", mac)
        self.model.write_on_section("Information", "OUI", oui)
        self.model.write_on_section("Information", "Company", company)

    def open_project(self):
        filename = QtGui.QFileDialog.getOpenFileName(None,
                                                     'Open File',
                                                     str(expanduser("~")),
                                                     'Configuration file (*.ini)')
        if filename:
            self.model = ProjectModel(filename)
            return True
        else:
            return False
