from database.dbhelper import DBHelper
from lib.io.network import ping
from lib.io.projectfile import ProjectFile
from views.dialog.settingsview import SettingsView


class SettingsController(object):
    def __init__(self):
        self.__projectFile = None
        self.__DBHelper = DBHelper()
        self.settingsView = SettingsView(self)

    def getProjectFile(self):
        return self.__projectFile

    def getInformation(self, IP):
        mac, info = self.__DBHelper.fetchone(IP)

        if not mac and not info:
            mac = oui = company = "Unknown"
        else:
            oui = info[1]
            company = info[2]

        return mac, oui, company

    @staticmethod
    def isAlive(IP):
        return ping(IP)

    def saveProjectFile(self, data):
        if self.__projectFile.readValue("Information", "Name") != data['name']:
            self.__projectFile = ProjectFile(data['location'], data['name'])

        self.__projectFile.write("Information", "Location", data['location'])
        self.__projectFile.write("Information", "Name", data['name'])
        self.__projectFile.write("Information", "IP", data['ip'])
        self.__projectFile.write("Information", "MAC", data['mac'])
        self.__projectFile.write("Information", "OUI", data['oui'])
        self.__projectFile.write("Information", "Company", data['company'])

    def setProjectFile(self, projectFile):
        self.__projectFile = projectFile
        data = {'name': projectFile.readValue("Information", "Name"),
                'location': projectFile.readValue("Information", "Location"),
                'ip': projectFile.readValue("Information", "IP"),
                'mac': projectFile.readValue("Information", "MAC"),
                'oui': projectFile.readValue("Information", "OUI"),
                'company': projectFile.readValue("Information", "Company"),
                'router': projectFile.readValue("Information", "Router"),
                'model': projectFile.readValue("Information", "Model")}

        self.settingsView.setInformation(data)

    def show(self):
        value = self.settingsView.exec_()
        while value < 0:
            value = self.settingsView.exec_()
