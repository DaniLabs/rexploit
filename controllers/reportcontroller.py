from lib.io.pdf import PDF
from lib.io.cwe import CWE
from lib.io.parse import removeHTML


class ReportController(object):
    def __init__(self):
        self.__projectFile = None
        self.__pdf = PDF()
        self.__cwe = CWE()
        # I believe that is interesting create a view which permit add a comment about the project
        # and finally create PDF.
        # self.__reportView = ReportView(self)

    def create(self):
        self.__pdf.create()

        self.__pdf.writeSection("General Information", 1)
        self.__pdf.writeText("Project's name: ", self.__projectFile.readValue("Information", "Name"), 30)
        self.__pdf.writeText("IP Address: ", self.__projectFile.readValue("Information", "IP"), 22)
        self.__pdf.writeText("MAC Address: ", self.__projectFile.readValue("Information", "MAC"), 28)
        self.__pdf.writeText("OUI: ", self.__projectFile.readValue("Information", "OUI"), 12)
        self.__pdf.writeText("Company: ", self.__projectFile.readValue("Information", "Company"), 20)
        self.__pdf.writeText("Router: ", self.__projectFile.readValue("Information", "Router"), 15)

        self.__pdf.writeSection("Exploits available", 1)

        items = self.__projectFile.getSections("Exploit")
        for i, section in enumerate(items):
            self.__pdf.writeSection("#{0} Exploit".format(i), 2)
            self.__pdf.writeText("Name: ", section[0][1], 15)
            self.__pdf.writeText("Author(s): ", section[1][1], 20)
            description = section[2][1].split(".")
            for i, d in enumerate(description):
                if i == 0:
                    self.__pdf.writeText("Description: ", d, 25)
                else:
                    self.__pdf.writeText("", d, 25)
            cwe = removeHTML(self.__cwe.get(int(section[3][1])))
            self.__pdf.writeText("CWE: ", cwe, 15)
            self.__pdf.writeText("Targets: ", section[4][1], 20)
            self.__pdf.writeText("References: ", section[5][1], 25)

        self.__pdf.writeSection("Ports & services available", 1)
        items = self.__projectFile.getSections("Target")
        for i, section in enumerate(items):
            self.__pdf.writeSection("#{0} Service".format(i), 2)
            self.__pdf.writeText("Protocol: ", section[0][1], 20)
            self.__pdf.writeText("Port: ", section[1][1], 10)
            self.__pdf.writeText("Service: ", section[2][1], 20)
            self.__pdf.writeText("State: ", section[3][1], 15)
            self.__pdf.writeText("Product: ", section[4][1], 20)
            self.__pdf.writeText("Extra: ", section[5][1], 20)

        self.__pdf.save()

    def setProjectFile(self, projectFile):
        self.__projectFile = projectFile
